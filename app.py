import streamlit as st
import pandas as pd
import math
from datetime import datetime, timedelta, timezone

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì—˜ë‘ë¹„íƒˆ ì •ê¸°ë°°ì†¡", page_icon="ğŸ­", layout="wide")

# [ì¤‘ìš”] í•œêµ­ ì‹œê°„(KST) ì„¤ì •
KST = timezone(timedelta(hours=9))

# 2. ë³´ì•ˆ ì„¤ì •
def check_password():
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False
    def password_entered():
        if st.session_state["password"] == "I love VPMI":
            st.session_state.authenticated = True
            del st.session_state["password"]
        else:
            st.session_state.authenticated = False
    if not st.session_state.authenticated:
        c1, c2, c3 = st.columns([1,2,1])
        with c2:
            st.title("ğŸ”’ ì—˜ë‘ë¹„íƒˆ ERP v.5.0")
            with st.form("login"):
                st.text_input("ë¹„ë°€ë²ˆí˜¸:", type="password", key="password")
                st.form_submit_button("ë¡œê·¸ì¸", on_click=password_entered)
        return False
    return True

if not check_password():
    st.stop()

# 3. ë°ì´í„° ì´ˆê¸°í™”
def add_patient(db, name, group, note, default, items):
    db[name] = {"group": group, "note": note, "default": default, "items": items}

def init_session_state():
    # (1) ë‚ ì§œ ì´ˆê¸°í™”
    if 'target_date' not in st.session_state:
        st.session_state.target_date = datetime.now(KST)
    
    # (2) ì—°ê°„ ì¼ì • DB
    if 'schedule_db' not in st.session_state:
        st.session_state.schedule_db = {
            1: {"title": "1ì›” (JAN)", "main": ["ë™ë°±ê½ƒ (ëŒ€ì‚¬/í•„í„°ë§)", "ì¸ì‚¼ì‚¬ì´ë‹¤ (ë³‘ì…)", "ìœ ê¸°ë† ìš°ìœ  ì»¤ë“œ"], "note": "ë™ë°±ê½ƒ pH 3.8~4.0 ë„ë‹¬ ì‹œ ì¢…ë£Œ"},
            2: {"title": "2ì›” (FEB)", "main": ["ê°ˆëŒ€ë¿Œë¦¬ (ì±„ì·¨/ê±´ì¡°/ëŒ€ì‚¬)", "ë‹¹ê·¼ (ëŒ€ì‚¬)"], "note": "ê°ˆëŒ€ë¿Œë¦¬ ì„¸ì²™ í›„ ê±´ì¡° ìˆ˜ìœ¨ ì•½ 37%"},
            3: {"title": "3ì›” (MAR)", "main": ["ë´„ê½ƒ ëŒ€ì‚¬ (ì¥ë¯¸, í”„ë¦¬ì§€ì•„, ì¹´ë„¤ì´ì…˜ ë“±)", "í‘œê³ ë²„ì„¯", "ì»¤í”¼ì½©(ì‹¤í—˜)"], "note": "ê½ƒ:ì¤„ê¸° ë¹„ìœ¨ 1:1 í…ŒìŠ¤íŠ¸"},
            4: {"title": "4ì›” (APR)", "main": ["ì• ê¸°ë˜¥í’€ (ì±„ì·¨ ì‹œì‘)", "ë“±ë‚˜ë¬´ê½ƒ", "ë¨¸ìœ„", "ì‚°ë§ˆëŠ˜"], "note": "ì• ê¸°ë˜¥í’€ ì „ì´ˆ ì‚¬ìš©"},
            5: {"title": "5ì›” (MAY)", "main": ["ê°œë§ì´ˆê½ƒ+ì•„ì¹´ì‹œì•„ì í•©ì œ ëŒ€ì‚¬ (ê³„ë€ì»¤ë“œìš© 8:1)", "ì•„ì¹´ì‹œì•„ê½ƒ (ëŒ€ëŸ‰ ìƒì‚°)", "ë½•ì", "êµ¬ì°Œë½•"], "note": "ê³„ë€ì»¤ë“œ ìŠ¤íƒ€í„°ìš© í•©ì œ ëŒ€ì‚¬ ì‹œì‘"},
            6: {"title": "6ì›” (JUN)", "main": ["ë§¤ì‹¤ (ì²­ ì œì¡°)", "ê°œë§ì´ˆ (ì±„ì·¨/ëŒ€ì‚¬)", "ì™„ë‘ì½©"], "note": "ë§¤ì‹¤ ì”¨ ì œê±° í›„ ìœ¼ê¹¨ê±°ë‚˜ ì±„ì°ê¸°"},
            7: {"title": "7ì›” (JUL)", "main": ["ì—°ê½ƒ / ì—°ì", "ë¬´ê¶í™”", "ëª©ë°±ì¼í™", "í’‹ê³ ì¶”"], "note": "ì—¬ë¦„ì²  ëŒ€ì‚¬ ì†ë„ ë¹ ë¦„ ì£¼ì˜"},
            8: {"title": "8ì›” (AUG)", "main": ["í’‹ì‚¬ê³¼ (ëŒ€ì‚¬)", "ê°ì¢… ëŒ€ì‚¬ì²´ í•„í„°ë§/ì†Œí¬ì¥"], "note": "í’‹ì‚¬ê³¼ 1:6 ë¹„ìœ¨"},
            9: {"title": "9ì›” (SEP)", "main": ["ì²­ê·¤ (ëŒ€ì‚¬)", "ì¥ë¯¸ê½ƒ (ê°€ì„)", "ëŒ€íŒŒ"], "note": "ì¶”ì„ ì„ ë¬¼ì„¸íŠ¸ ì¤€ë¹„ ê¸°ê°„"},
            10: {"title": "10ì›” (OCT)", "main": ["ì†¡ì´ë²„ì„¯ (ë¶í•œì‚°/ìš¸ì§„ì‚°)", "í‘œê³ ë²„ì„¯", "ì‚°ìë‚˜ë¬´(ë¹„íƒ€ë¯¼ì—´ë§¤)"], "note": "ì†¡ì´ ë“±ì™¸í’ˆ í™œìš©"},
            11: {"title": "11ì›” (NOV)", "main": ["ë¬´ì—¼ê¹€ì¹˜ (ëŒ€ëŸ‰ ê¹€ì¥)", "ìƒì§€í™©", "ì¸ì‚¼(ìˆ˜ì‚¼/ìƒˆì‹¹ì‚¼)"], "note": "ê¹€ì¹˜ì†Œ+ìœ¡ìˆ˜ ë°°í•© ì¤‘ìš”"},
            12: {"title": "12ì›” (DEC)", "main": ["ë™ë°±ê½ƒ (ì±„ì·¨ ì‹œì‘)", "ë©”ì£¼ì½©(ë°±íƒœ)", "í•œ í•´ ë§ˆê°"], "note": "ë™ë°±ê½ƒ 1:6, 1:9, 1:12 ë¹„ìœ¨ ì‹¤í—˜"}
        }
    
    # (3) ë·° ëª¨ë“œ
    if 'view_month' not in st.session_state:
        st.session_state.view_month = st.session_state.target_date.month

    if 'product_list' not in st.session_state:
        plist = [
            "ì‹œì›í•œ ê²ƒ", "ë§ˆì‹œëŠ” ê²ƒ", "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ì»¤ë“œ", "EX",
            "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) ë‡Œì§ˆí™˜ìš©",
            "í‘œê³ ë²„ì„¯ ëŒ€ì‚¬ì²´", "ê°œë§ì´ˆ(EDF)", "ì¥ë¯¸ê½ƒ ëŒ€ì‚¬ì²´",
            "ì• ê¸°ë˜¥í’€ ëŒ€ì‚¬ì²´", "ì¸ì‚¼ ì‚¬ì´ë‹¤", "ì†¡ì´ ëŒ€ì‚¬ì²´",
            "PAGI í¬ì„ì•¡", "Vitamin C", "SiO2", "ê³„ë€ì»¤ë“œ ìŠ¤íƒ€í„°",
            "í˜¼í•© [E.R.P.V.P]", "í˜¼í•© [P.V.E]", "í˜¼í•© [P.P.E]",
            "í˜¼í•© [Ex.P]", "í˜¼í•© [R.P]", "í˜¼í•© [Edf.P]", "í˜¼í•© [P.P]"
        ]
        st.session_state.product_list = plist

    if 'patient_db' not in st.session_state:
        db = {}
        # -- ë‚¨ì–‘ì£¼ --
        # [ìˆ˜ì • v.5.0] ë‚¨ì–‘ì£¼ 1: ì»¤ë“œ 7ê°œ ì¶”ê°€
        items = [
            {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 21},
            {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14},
            {"ì œí’ˆ": "ì»¤ë“œ", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 7}, # ì¶”ê°€ë¨
            {"ì œí’ˆ": "EX", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 3},
            {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 7, "ë¹„ê³ ": "ì›ì•¡"},
            {"ì œí’ˆ": "í‘œê³ ë²„ì„¯ ëŒ€ì‚¬ì²´", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 7}
        ]
        add_patient(db, "ë‚¨ì–‘ì£¼ 1", "ë‚¨ì–‘ì£¼", "ë§¤ì£¼ ë°œì†¡", True, items)

        items = [{"ì œí’ˆ": "ë§ˆì‹œëŠ” ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì»¤ë“œ", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 7}, {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ê°œë§ì´ˆ(EDF)", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 7}, {"ì œí’ˆ": "ì¥ë¯¸ê½ƒ ëŒ€ì‚¬ì²´", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 3}]
        add_patient(db, "ë‚¨ì–‘ì£¼ 2", "ë‚¨ì–‘ì£¼", "âš ï¸ ì‹ ì¥ íˆ¬ì„ (ë§¤ì£¼)", True, items)

        items = [{"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ë§ˆì‹œëŠ” ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 7}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 7}, {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 7}, {"ì œí’ˆ": "ì• ê¸°ë˜¥í’€ ëŒ€ì‚¬ì²´", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 7}]
        add_patient(db, "ë‚¨ì–‘ì£¼ 4", "ë‚¨ì–‘ì£¼", "ë§¤ì£¼ ë°œì†¡", True, items)

        # -- ìœ ë°©ì•” --
        items = [{"ì œí’ˆ": "í˜¼í•© [E.R.P.V.P]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 42}, {"ì œí’ˆ": "ë§ˆì‹œëŠ” ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}]
        add_patient(db, "ê¹€ë™ë¯¼ ë¶€ì¸", "ìœ ë°©ì•”", "2ì£¼ ê°„ê²©", True, items)
        
        items = [{"ì œí’ˆ": "ì¸ì‚¼ ì‚¬ì´ë‹¤", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ë§ˆì‹œëŠ” ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}, {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì†¡ì´ ëŒ€ì‚¬ì²´", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 14}]
        add_patient(db, "ê¹€ê·€ë¡€", "ìœ ë°©ì•”", "2ì£¼ ê°„ê²©", True, items)
        
        items = [{"ì œí’ˆ": "í˜¼í•© [P.V.E]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "í˜¼í•© [P.P.E]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 42}, {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 42}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}]
        add_patient(db, "ê¹€ì„±ê¸°", "ìœ ë°©ì•”", "2ì£¼ ê°„ê²©", True, items)
        
        items = [{"ì œí’ˆ": "ë§ˆì‹œëŠ” ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}, {"ì œí’ˆ": "ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 28}, {"ì œí’ˆ": "ì¸ì‚¼ ì‚¬ì´ë‹¤", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "ì¸ì‚¼ëŒ€ì‚¬ì²´(PAGI) í•­ì•”ìš©", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 14}]
        add_patient(db, "ìµœì€ì°¬", "ìœ ë°©ì•”", "2ì£¼ ê°„ê²©", True, items)
        
        items = [{"ì œí’ˆ": "í˜¼í•© [Ex.P]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "í˜¼í•© [R.P]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "í˜¼í•© [Edf.P]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "í˜¼í•© [P.P]", "ìš©ëŸ‰": "150ml", "ìˆ˜ëŸ‰": 14, "íƒ€ì…": "í˜¼í•©"}, {"ì œí’ˆ": "ì»¤ë“œ ì‹œì›í•œ ê²ƒ", "ìš©ëŸ‰": "280ml", "ìˆ˜ëŸ‰": 14}, {"ì œí’ˆ": "PAGI í¬ì„ì•¡", "ìš©ëŸ‰": "50ml", "ìˆ˜ëŸ‰": 14}]
        add_patient(db, "í•˜í˜œìˆ™", "ìœ ë°©ì•”", "2ì£¼ ê°„ê²©", True, items)
